---
phase: 01-foundation-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/package.json
  - src/tsconfig.json
  - src/index.ts
  - src/server.ts
autonomous: true

must_haves:
  truths:
    - "Server compiles with SDK 1.25.2 without errors"
    - "Server starts and logs to stderr only"
    - "npm run build succeeds with zero errors"
    - "Zod is pinned to 3.22.x and installed as peer dependency"
  artifacts:
    - path: "src/package.json"
      provides: "Updated dependencies with SDK 1.25.2 and Zod 3.22.x"
      contains: "@modelcontextprotocol/sdk.*1\\.2"
    - path: "src/tsconfig.json"
      provides: "TypeScript config for ES modules"
      contains: "module.*NodeNext"
    - path: "src/index.ts"
      provides: "Entry point with updated imports"
      contains: "@modelcontextprotocol/sdk/server/mcp.js"
  key_links:
    - from: "src/index.ts"
      to: "@modelcontextprotocol/sdk"
      via: "ES module import"
      pattern: "from.*@modelcontextprotocol/sdk"
---

<objective>
Upgrade the Bexio MCP server from SDK 0.5.0 to 1.25.2 with all breaking changes addressed.

Purpose: The SDK upgrade is the foundation for all v2 work. SDK 1.25.2 has breaking changes in import paths, transport API, and Zod peer dependency handling that must be addressed before any tool migration can occur.

Output: A compiling v2 project skeleton with correct dependencies, import paths, and TypeScript configuration. The server will start but tools are not yet wired (that's Plan 02 and 03).
</objective>

<execution_context>
@C:\Users\calvi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\calvi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@D:\AI\Bexio MCP v2\.planning\PROJECT.md
@D:\AI\Bexio MCP v2\.planning\ROADMAP.md
@D:\AI\Bexio MCP v2\.planning\research\SUMMARY.md

# v1 reference files (read, do not modify)
@D:\AI\Bexio MCP v2\mcp_bexio-main-v1\package.json
@D:\AI\Bexio MCP v2\mcp_bexio-main-v1\src\index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize v2 project with updated dependencies</name>
  <files>
    D:\AI\Bexio MCP v2\src\package.json
    D:\AI\Bexio MCP v2\src\tsconfig.json
    D:\AI\Bexio MCP v2\.env.example
  </files>
  <action>
Create the v2 src/ directory and initialize with:

1. Create `src/package.json`:
   - name: "bexio-mcp-server"
   - version: "2.0.0"
   - type: "module"
   - dependencies:
     - "@modelcontextprotocol/sdk": "^1.25.2" (upgraded from 0.5.0)
     - "axios": "^1.7.0" (keep existing)
     - "zod": "3.22.5" (pinned exact version - NOT ^3.22.0 - to avoid Zod v4 compatibility issues)
     - "dotenv": "^16.3.0" (keep existing)
   - devDependencies:
     - "@types/node": "^20.8.0"
     - "typescript": "^5.5.0" (upgraded for Zod strict mode)
     - "tsx": "^4.0.0" (upgraded)
     - "vitest": "^2.0.0" (upgraded)
   - scripts:
     - "build": "tsc"
     - "dev": "tsx watch src/index.ts"
     - "start": "node dist/index.js"
     - "test": "vitest"
     - "type-check": "tsc --noEmit"
   - DO NOT include fastify/@fastify/cors in core package (HTTP transport will be separate)

2. Create `src/tsconfig.json`:
   - target: "ES2022"
   - module: "NodeNext"
   - moduleResolution: "NodeNext"
   - strict: true
   - esModuleInterop: true
   - outDir: "./dist"
   - rootDir: "./"
   - declaration: true

3. Create `.env.example`:
   - BEXIO_API_TOKEN=your_api_token_here
   - BEXIO_BASE_URL=https://api.bexio.com/2.0

**Why these specific versions:**
- Zod 3.22.5 pinned exactly (not caret) because Zod v4 causes `w._parse is not a function` errors with MCP SDK
- TypeScript 5.5.0 for better Zod type inference
- tsx 4.0 for ESM watch mode compatibility
  </action>
  <verify>
Run in src/ directory:
```
npm install
npm run type-check
```
Both commands should complete without errors.
  </verify>
  <done>
- package.json exists with SDK 1.25.2 and Zod 3.22.5 (exact)
- tsconfig.json exists with NodeNext module resolution
- npm install completes without peer dependency warnings
- npm run type-check returns exit code 0
  </done>
</task>

<task type="auto">
  <name>Task 2: Create minimal server skeleton with SDK 1.25.2 patterns</name>
  <files>
    D:\AI\Bexio MCP v2\src\index.ts
    D:\AI\Bexio MCP v2\src\server.ts
    D:\AI\Bexio MCP v2\src\logger.ts
  </files>
  <action>
Create the minimal server structure that compiles and starts with SDK 1.25.2:

1. Create `src/logger.ts`:
   - Create a simple logger that ONLY writes to stderr (never stdout)
   - Export functions: debug(), info(), warn(), error()
   - All functions use console.error() internally
   - Include timestamp and level prefix
   - This prevents stdout contamination that breaks JSON-RPC protocol

```typescript
// Pattern to follow:
export function info(message: string, ...args: unknown[]): void {
  console.error(`[INFO] ${new Date().toISOString()} ${message}`, ...args);
}
```

2. Create `src/server.ts`:
   - Import from "@modelcontextprotocol/sdk/server/mcp.js" (new path in 1.25.2, NOT /server/index.js)
   - Import StdioServerTransport from "@modelcontextprotocol/sdk/server/stdio.js"
   - Create McpServer class that wraps the SDK Server
   - For now, register NO tools (just empty tools capability)
   - Create run() method that connects to StdioServerTransport
   - Use logger.ts for all logging (never console.log)

Key SDK 1.25.2 changes from 0.5.0:
- Import path: `@modelcontextprotocol/sdk/server/mcp.js` (not /server/index.js)
- Server constructor takes (serverInfo, options) where options has capabilities
- Use `server.connect(transport)` to start (replaces older patterns)
- Cannot register capabilities after connection

3. Create `src/index.ts`:
   - Load dotenv config
   - Parse command line args for --mode (stdio only for now)
   - Validate BEXIO_API_TOKEN environment variable
   - Create and run server
   - Use logger for all output

**Critical: No console.log() anywhere.** MCP protocol uses stdout for JSON-RPC. Any non-JSON output corrupts the protocol.
  </action>
  <verify>
```bash
cd src && npm run build
node dist/index.js 2>&1 | head -5
```
Build should succeed. Running index.js should show stderr log output (not stdout).
  </verify>
  <done>
- src/logger.ts exists with stderr-only logging functions
- src/server.ts exists with SDK 1.25.2 import paths and Server class
- src/index.ts exists with environment validation and server startup
- npm run build completes without errors
- No console.log() statements in any file (grep confirms)
  </done>
</task>

<task type="auto">
  <name>Task 3: Validate SDK integration with stdio transport</name>
  <files>
    D:\AI\Bexio MCP v2\src\server.ts
  </files>
  <action>
Verify the server correctly handles MCP protocol initialization:

1. Add a simple test tool to server.ts to validate the SDK integration:
   - Tool name: "ping"
   - Description: "Test tool that returns pong"
   - No input parameters
   - Returns: { content: [{ type: "text", text: "pong" }] }

2. Register the tool using SDK 1.25.2 patterns:
   - Use server.setRequestHandler(ListToolsRequestSchema, ...) for tool listing
   - Use server.setRequestHandler(CallToolRequestSchema, ...) for tool calls
   - Import schemas from "@modelcontextprotocol/sdk/types.js"

3. Test the server responds correctly:
   - Server should respond to tools/list with the ping tool
   - Server should respond to tools/call for ping with "pong"

This validates:
- SDK imports work correctly
- Server initializes properly
- Tool registration works
- JSON-RPC protocol is not corrupted by stdout
  </action>
  <verify>
```bash
cd src && npm run build

# Test that server starts and accepts JSON-RPC
echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}' | node dist/index.js 2>/dev/null | head -1
```
Should return a JSON response with `{"jsonrpc":"2.0","id":1,"result":{...}}` containing server capabilities.
  </verify>
  <done>
- ping tool is registered and responds correctly
- Server accepts initialize request and returns capabilities
- No stderr output appears in stdout (JSON-RPC stream is clean)
- Tools/list returns ping tool definition
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   cd D:/AI/Bexio\ MCP\ v2/src && npm run build
   ```
   Must exit with code 0.

2. **No stdout contamination:**
   ```bash
   grep -r "console.log" src/*.ts
   ```
   Must return no matches.

3. **SDK version verification:**
   ```bash
   grep "@modelcontextprotocol/sdk" src/package.json
   ```
   Must show version 1.25.2.

4. **Zod version verification:**
   ```bash
   grep '"zod"' src/package.json
   ```
   Must show exactly "3.22.5" (not ^3.22.0).

5. **Protocol test:**
   ```bash
   echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}' | node dist/index.js 2>/dev/null
   ```
   Must return valid JSON-RPC response.
</verification>

<success_criteria>
- npm install completes without peer dependency warnings
- npm run build completes with exit code 0
- Server starts and responds to MCP initialize request
- No console.log() in codebase (all output via stderr logger)
- SDK version is 1.25.2 (not 0.5.0)
- Zod version is exactly 3.22.5 (pinned)
- TypeScript compilation produces no errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-migration/01-01-SUMMARY.md` using the summary template.

Key information to capture:
- Actual SDK/Zod versions installed
- Any unexpected issues during migration
- Import path patterns used
- Logger implementation approach
</output>
