---
phase: 01-foundation-migration
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/tools/invoices/definitions.ts
  - src/tools/invoices/handlers.ts
  - src/tools/invoices/index.ts
  - src/tools/orders/definitions.ts
  - src/tools/orders/handlers.ts
  - src/tools/orders/index.ts
  - src/tools/quotes/definitions.ts
  - src/tools/quotes/handlers.ts
  - src/tools/quotes/index.ts
  - src/tools/payments/definitions.ts
  - src/tools/payments/handlers.ts
  - src/tools/payments/index.ts
  - src/tools/reminders/definitions.ts
  - src/tools/reminders/handlers.ts
  - src/tools/reminders/index.ts
  - src/tools/deliveries/definitions.ts
  - src/tools/deliveries/handlers.ts
  - src/tools/deliveries/index.ts
  - src/tools/items/definitions.ts
  - src/tools/items/handlers.ts
  - src/tools/items/index.ts
  - src/tools/reports/definitions.ts
  - src/tools/reports/handlers.ts
  - src/tools/reports/index.ts
  - src/tools/users/definitions.ts
  - src/tools/users/handlers.ts
  - src/tools/users/index.ts
  - src/tools/misc/definitions.ts
  - src/tools/misc/handlers.ts
  - src/tools/misc/index.ts
  - src/tools/index.ts
  - src/types/schemas/payments.ts
  - src/types/schemas/reminders.ts
  - src/types/schemas/deliveries.ts
  - src/types/schemas/items.ts
  - src/types/schemas/reports.ts
  - src/types/schemas/users.ts
  - src/types/schemas/misc.ts
  - src/types/schemas/index.ts
  - src/transports/http.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "All 83 v1 tools are available in tools/list response"
    - "Tool names are identical to v1 (backward compatible)"
    - "Each domain module is under 200 lines per file"
    - "HTTP transport works for n8n access"
    - "Server responds correctly to tool calls"
  artifacts:
    - path: "src/tools/invoices/definitions.ts"
      provides: "Invoice tool definitions (13 tools)"
      contains: "list_invoices"
    - path: "src/tools/quotes/definitions.ts"
      provides: "Quote tool definitions (10 tools)"
      contains: "create_quote"
    - path: "src/tools/orders/definitions.ts"
      provides: "Order tool definitions (6 tools)"
      contains: "list_orders"
    - path: "src/tools/index.ts"
      provides: "Aggregation of all 83 tools"
      contains: "getAllToolDefinitions"
    - path: "src/transports/http.ts"
      provides: "HTTP transport for n8n"
      contains: "createHttpServer"
  key_links:
    - from: "src/tools/index.ts"
      to: "src/tools/*/index.ts"
      via: "imports all domain modules"
      pattern: "from.*\\./invoices"
    - from: "src/index.ts"
      to: "src/transports/http.ts"
      via: "HTTP mode startup"
      pattern: "import.*http"
---

<objective>
Migrate all 83 v1 tools to the new modular structure with HTTP transport support.

Purpose: Complete the Phase 1 migration by extracting all remaining tools from v1's monolithic server.ts into domain-organized modules, and restore HTTP transport for n8n users.

Output: Fully functional v2 server with all 83 tools working, backward compatible tool names, dual transport (stdio + HTTP), and modular codebase.
</objective>

<execution_context>
@C:\Users\calvi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\calvi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@D:\AI\Bexio MCP v2\.planning\PROJECT.md
@D:\AI\Bexio MCP v2\.planning\REQUIREMENTS.md
@D:\AI\Bexio MCP v2\.planning\phases\01-foundation-migration\01-02-SUMMARY.md

# v1 reference files (for tool extraction)
@D:\AI\Bexio MCP v2\mcp_bexio-main-v1\src\server.ts
@D:\AI\Bexio MCP v2\mcp_bexio-main-v1\src\types.ts
@D:\AI\Bexio MCP v2\mcp_bexio-main-v1\src\http-server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate remaining tool domains (invoices through misc)</name>
  <files>
    D:\AI\Bexio MCP v2\src\tools\invoices\definitions.ts
    D:\AI\Bexio MCP v2\src\tools\invoices\handlers.ts
    D:\AI\Bexio MCP v2\src\tools\invoices\index.ts
    D:\AI\Bexio MCP v2\src\tools\orders\definitions.ts
    D:\AI\Bexio MCP v2\src\tools\orders\handlers.ts
    D:\AI\Bexio MCP v2\src\tools\orders\index.ts
    D:\AI\Bexio MCP v2\src\tools\quotes\definitions.ts
    D:\AI\Bexio MCP v2\src\tools\quotes\handlers.ts
    D:\AI\Bexio MCP v2\src\tools\quotes\index.ts
    D:\AI\Bexio MCP v2\src\tools\payments\definitions.ts
    D:\AI\Bexio MCP v2\src\tools\payments\handlers.ts
    D:\AI\Bexio MCP v2\src\tools\payments\index.ts
    D:\AI\Bexio MCP v2\src\tools\reminders\definitions.ts
    D:\AI\Bexio MCP v2\src\tools\reminders\handlers.ts
    D:\AI\Bexio MCP v2\src\tools\reminders\index.ts
    D:\AI\Bexio MCP v2\src\tools\deliveries\definitions.ts
    D:\AI\Bexio MCP v2\src\tools\deliveries\handlers.ts
    D:\AI\Bexio MCP v2\src\tools\deliveries\index.ts
    D:\AI\Bexio MCP v2\src\tools\items\definitions.ts
    D:\AI\Bexio MCP v2\src\tools\items\handlers.ts
    D:\AI\Bexio MCP v2\src\tools\items\index.ts
    D:\AI\Bexio MCP v2\src\tools\reports\definitions.ts
    D:\AI\Bexio MCP v2\src\tools\reports\handlers.ts
    D:\AI\Bexio MCP v2\src\tools\reports\index.ts
    D:\AI\Bexio MCP v2\src\tools\users\definitions.ts
    D:\AI\Bexio MCP v2\src\tools\users\handlers.ts
    D:\AI\Bexio MCP v2\src\tools\users\index.ts
    D:\AI\Bexio MCP v2\src\tools\misc\definitions.ts
    D:\AI\Bexio MCP v2\src\tools\misc\handlers.ts
    D:\AI\Bexio MCP v2\src\tools\misc\index.ts
  </files>
  <action>
Extract all remaining tools from v1 server.ts into domain modules following the contacts pattern from Plan 02.

**Tool distribution by domain (83 total, contacts handled in Plan 02):**

1. **invoices/** (15 tools):
   - list_invoices, list_all_invoices, get_invoice, search_invoices, search_invoices_by_customer
   - create_invoice, issue_invoice, cancel_invoice, mark_invoice_as_sent, send_invoice, copy_invoice
   - list_invoice_statuses, list_all_statuses
   - get_open_invoices, get_overdue_invoices

2. **orders/** (7 tools):
   - list_orders, get_order, create_order, search_orders, search_orders_by_customer
   - create_delivery_from_order, create_invoice_from_order

3. **quotes/** (11 tools):
   - list_quotes, get_quote, create_quote, search_quotes, search_quotes_by_customer
   - issue_quote, accept_quote, decline_quote, send_quote
   - create_order_from_quote, create_invoice_from_quote

4. **payments/** (4 tools):
   - list_payments, get_payment, create_payment, delete_payment

5. **reminders/** (8 tools):
   - list_reminders, get_reminder, create_reminder, delete_reminder
   - mark_reminder_as_sent, send_reminder, search_reminders, get_reminders_sent_this_week

6. **deliveries/** (4 tools):
   - list_deliveries, get_delivery, issue_delivery, search_deliveries

7. **items/** (5 tools):
   - list_items, get_item, create_item, list_taxes, get_tax

8. **reports/** (7 tools):
   - get_revenue_report, get_customer_revenue_report, get_invoice_status_report
   - get_overdue_invoices_report, get_monthly_revenue_report, get_top_customers_by_revenue
   - get_tasks_due_this_week

9. **users/** (6 tools):
   - get_current_user
   - list_fictional_users, get_fictional_user, create_fictional_user
   - update_fictional_user, delete_fictional_user

10. **misc/** (9 tools):
    - list_comments, get_comment, create_comment
    - list_contact_relations, get_contact_relation, create_contact_relation
    - update_contact_relation, delete_contact_relation, search_contact_relations

**Plus contacts/ (7 tools) from Plan 02 = 83 total**

**For each domain, create three files:**

1. **definitions.ts**: Tool definitions array
   - Copy inputSchema from v1 getToolDefinitions()
   - Keep tool names EXACTLY as in v1 (backward compatibility)
   - Keep descriptions EXACTLY as in v1

2. **handlers.ts**: Handler implementations
   - Copy logic from v1 handleToolCall() switch cases
   - Parse args with Zod schema
   - Call BexioClient method
   - Throw McpError on failures
   - Return result (response formatting done by server)

3. **index.ts**: Barrel export
   - Export { toolDefinitions } from './definitions.js'
   - Export { handlers } from './handlers.js'

**Critical: Preserve all 83 tool names exactly (see v1 server.ts for authoritative list)**

The complete list is in v1 server.ts getToolDefinitions(). Key tool names by domain:

- **contacts (7):** list_contacts, get_contact, search_contacts, advanced_search_contacts, find_contact_by_number, find_contact_by_name, update_contact
- **invoices (15):** list_invoices, list_all_invoices, get_invoice, search_invoices, search_invoices_by_customer, create_invoice, issue_invoice, cancel_invoice, mark_invoice_as_sent, send_invoice, copy_invoice, list_invoice_statuses, list_all_statuses, get_open_invoices, get_overdue_invoices
- **quotes (11):** create_quote, list_quotes, get_quote, search_quotes, search_quotes_by_customer, issue_quote, accept_quote, decline_quote, send_quote, create_order_from_quote, create_invoice_from_quote
- **orders (7):** list_orders, get_order, create_order, search_orders, search_orders_by_customer, create_delivery_from_order, create_invoice_from_order
- **payments (4):** list_payments, get_payment, create_payment, delete_payment
- **reminders (8):** list_reminders, get_reminder, create_reminder, delete_reminder, mark_reminder_as_sent, send_reminder, search_reminders, get_reminders_sent_this_week
- **deliveries (4):** list_deliveries, get_delivery, issue_delivery, search_deliveries
- **items (5):** list_items, get_item, create_item, list_taxes, get_tax
- **reports (7):** get_revenue_report, get_customer_revenue_report, get_invoice_status_report, get_overdue_invoices_report, get_monthly_revenue_report, get_top_customers_by_revenue, get_tasks_due_this_week
- **users (6):** get_current_user, list_fictional_users, get_fictional_user, create_fictional_user, update_fictional_user, delete_fictional_user
- **misc (9):** list_comments, get_comment, create_comment, list_contact_relations, get_contact_relation, create_contact_relation, update_contact_relation, delete_contact_relation, search_contact_relations
  </action>
  <verify>
```bash
cd src && npm run build
# Count total tools
echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}
{"jsonrpc":"2.0","id":2,"method":"tools/list","params":{}}' | node dist/index.js 2>/dev/null | jq '.result.tools | length'
```
Should return 83 (all v1 tools).
  </verify>
  <done>
- All 10 domain directories exist under tools/
- Each domain has definitions.ts, handlers.ts, index.ts
- 83 tools total in tools/list response
- All tool names match v1 exactly
- Each file is under 200 lines
  </done>
</task>

<task type="auto">
  <name>Task 2: Create missing type schemas and update aggregation</name>
  <files>
    D:\AI\Bexio MCP v2\src\types\schemas\payments.ts
    D:\AI\Bexio MCP v2\src\types\schemas\reminders.ts
    D:\AI\Bexio MCP v2\src\types\schemas\deliveries.ts
    D:\AI\Bexio MCP v2\src\types\schemas\items.ts
    D:\AI\Bexio MCP v2\src\types\schemas\reports.ts
    D:\AI\Bexio MCP v2\src\types\schemas\users.ts
    D:\AI\Bexio MCP v2\src\types\schemas\misc.ts
    D:\AI\Bexio MCP v2\src\types\schemas\index.ts
    D:\AI\Bexio MCP v2\src\tools\index.ts
  </files>
  <action>
Create remaining type schemas and update tools aggregation:

1. Create type schemas for remaining domains:
   - `types/schemas/payments.ts`: ListPayments, GetPayment, CreatePayment, DeletePayment param schemas
   - `types/schemas/reminders.ts`: All reminder operation param schemas
   - `types/schemas/deliveries.ts`: All delivery operation param schemas
   - `types/schemas/items.ts`: Item and tax param schemas
   - `types/schemas/reports.ts`: All report param schemas
   - `types/schemas/users.ts`: Fictional user param schemas
   - `types/schemas/misc.ts`: Comment and contact relation param schemas

   Extract from v1 types.ts (lines 200+).

2. Update `types/schemas/index.ts`:
   - Re-export all new schema files
   - Single import point for all schemas

3. Update `src/tools/index.ts`:
   - Import all domain modules (invoices, orders, quotes, payments, reminders, deliveries, items, reports, users, misc)
   - getAllToolDefinitions() aggregates all
   - getHandler() looks up from all domains
   - createHandlerRegistry() builds complete registry

Example tools/index.ts structure:
```typescript
import { toolDefinitions as contactsTools, handlers as contactsHandlers } from './contacts/index.js';
import { toolDefinitions as invoicesTools, handlers as invoicesHandlers } from './invoices/index.js';
// ... all domains

export function getAllToolDefinitions(): Tool[] {
  return [
    ...contactsTools,
    ...invoicesTools,
    // ... all domains
  ];
}

export function createHandlerRegistry(client: BexioClient): Map<string, HandlerFn> {
  return new Map([
    ...Object.entries(contactsHandlers).map(([name, fn]) => [name, (args) => fn(client, args)]),
    ...Object.entries(invoicesHandlers).map(([name, fn]) => [name, (args) => fn(client, args)]),
    // ... all domains
  ]);
}
```
  </action>
  <verify>
```bash
cd src && npm run type-check
npm run build
```
Both must pass without errors.
  </verify>
  <done>
- All type schema files exist (payments, reminders, deliveries, items, reports, users, misc)
- types/schemas/index.ts exports all schemas
- tools/index.ts imports all 10 domains
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Add HTTP transport and validate full functionality</name>
  <files>
    D:\AI\Bexio MCP v2\src\transports\http.ts
    D:\AI\Bexio MCP v2\src\transports\index.ts
    D:\AI\Bexio MCP v2\src\index.ts
    D:\AI\Bexio MCP v2\src\package.json
  </files>
  <action>
Add HTTP transport for n8n/remote access:

1. Update `src/package.json`:
   - Add optional dependencies for HTTP mode:
     - "fastify": "^4.28.0"
     - "@fastify/cors": "^9.0.0"
   - These are only used when --mode http is specified

2. Create `src/transports/http.ts`:
   - Copy and adapt from v1 http-server.ts
   - Use SDK 1.25.2 patterns (if StreamableHTTPServerTransport available, use it)
   - Otherwise, create Fastify wrapper that:
     - Accepts POST /mcp with JSON-RPC body
     - Passes to server.handleRequest()
     - Returns JSON-RPC response
   - CORS enabled for browser/n8n access
   - Use logger for all output (no console.log)
   - Host/port from command line args

3. Create `src/transports/index.ts`:
   - Export createHttpServer from http.ts
   - Conditional import to avoid loading Fastify in stdio mode

4. Update `src/index.ts`:
   - Parse --mode argument (stdio | http)
   - Parse --host and --port for HTTP mode
   - If stdio: use StdioServerTransport
   - If http: use createHttpServer
   - Validate BEXIO_API_TOKEN for both modes
   - Log mode selection to stderr

5. Create final validation tests:
   - Test stdio mode with JSON-RPC via stdin
   - Test HTTP mode with curl

**Critical for n8n compatibility:**
- CORS must allow all origins (or configurable)
- Must accept application/json content type
- Must handle JSON-RPC batch requests (array of requests)
  </action>
  <verify>
```bash
cd src && npm run build

# Test stdio mode
echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}
{"jsonrpc":"2.0","id":2,"method":"tools/list","params":{}}' | node dist/index.js 2>/dev/null | jq '.result.tools | length'

# Test HTTP mode (if port available)
# node dist/index.js --mode http --port 8765 &
# curl -X POST http://localhost:8765/mcp -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","id":1,"method":"tools/list","params":{}}'
```
  </verify>
  <done>
- transports/http.ts provides HTTP/Fastify server
- index.ts supports --mode stdio and --mode http
- stdio mode: 83 tools in tools/list
- HTTP mode: starts and accepts requests
- All logging goes to stderr
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Total tool count:**
   ```bash
   echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}
   {"jsonrpc":"2.0","id":2,"method":"tools/list","params":{}}' | node dist/index.js 2>/dev/null | jq '.result.tools | length'
   ```
   Must return exactly 56.

2. **Backward compatibility check:**
   ```bash
   # Extract tool names and compare with v1
   echo '...' | node dist/index.js 2>/dev/null | jq -r '.result.tools[].name' | sort > /tmp/v2_tools.txt
   # Compare with v1 tool list (should match exactly)
   ```

3. **File size check:**
   ```bash
   find src/tools -name "*.ts" -exec wc -l {} \; | awk '{if ($1 > 200) print "TOO LARGE:", $2}'
   ```
   Should return nothing (no files over 200 lines).

4. **HTTP transport:**
   ```bash
   node dist/index.js --mode http --port 8765 &
   PID=$!
   sleep 2
   curl -s -X POST http://localhost:8765/mcp \
     -H "Content-Type: application/json" \
     -d '{"jsonrpc":"2.0","id":1,"method":"tools/list","params":{}}' | jq '.result.tools | length'
   kill $PID
   ```
   Should return 83.

5. **No stdout contamination:**
   ```bash
   grep -r "console.log" src/**/*.ts
   ```
   Must return no matches.
</verification>

<success_criteria>
- All 83 v1 tools are available (tools/list returns 56)
- All tool names are identical to v1 (backward compatible)
- Tools organized into 10 domain directories
- Each file under 200 lines (except bexio-client.ts)
- Stdio transport works (default mode)
- HTTP transport works (--mode http)
- TypeScript compiles without errors
- No console.log in codebase
- Phase 1 requirements satisfied:
  - FOUND-01: SDK 1.25.2 (done in Plan 01)
  - FOUND-02: Modular architecture (done)
  - FOUND-05: Dual transport (done)
  - FOUND-06: Zod 3.22.x (done in Plan 01)
  - FOUND-07: stderr logging (done)
  - EXIST-01 through EXIST-12: All 83 tools working (done)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-migration/01-03-SUMMARY.md` using the summary template.

Key information to capture:
- Final tool count (should be 56)
- Domain distribution (tools per domain)
- File line counts
- HTTP transport implementation details
- Any behavior changes from v1 (should be none)
- Ready for Phase 2 (Reference Data & Banking)
</output>
